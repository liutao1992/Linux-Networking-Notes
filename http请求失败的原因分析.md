## web性能测试

### 文件描述符

在 Linux 系统中，文件描述符（File Descriptor, FD）是操作系统用来表示打开文件、套接字、管道等资源的整数标识符。每个进程在打开文件或创建网络连接时，都会分配一个文件描述符。由于文件描述符的数量是有限的，如果不合理管理，系统可能会因为达到文件描述符上限而出现问题，比如 "too many open files" 错误。

### 操作系统文件描述符使用情况的监控与管理：

#### 1. **查看当前系统的文件描述符限制**

Linux 系统对每个进程可以打开的文件描述符数量有限制。你可以通过 `ulimit` 命令查看和修改该限制。

- 查看当前用户可以使用的最大文件描述符数：

  ```bash
  ulimit -n
  ```

  这会显示当前用户进程可以打开的文件描述符数量上限。

- 查看系统全局的文件描述符限制：

  ```bash
  cat /proc/sys/fs/file-max
  ```

  这会显示整个系统范围内的文件描述符上限。这个值控制整个系统可以打开的文件描述符数量总和。

#### 2. **查看某个进程的文件描述符使用情况**

每个进程都有一个独立的文件描述符集。可以使用以下命令查看某个特定进程的文件描述符使用情况：

- 获取进程的文件描述符使用数：

  ```bash
  ls /proc/<PID>/fd | wc -l
  ```

  其中，`<PID>` 是目标进程的进程 ID。例如，想查看 NGINX 进程（假设其 PID 是 1234）的文件描述符使用情况：

  ```bash
  ls /proc/1234/fd | wc -l
  ```

  `/proc/<PID>/fd` 目录包含了该进程打开的所有文件描述符。

#### 3. **实时监控系统文件描述符的使用情况**

可以通过以下命令查看当前系统范围内使用的文件描述符数量以及总限制：

- 查看当前系统正在使用的文件描述符总数：

  ```bash
  cat /proc/sys/fs/file-nr
  ```

  输出示例：

  ```
  2345    0   123456
  ```

  解释：
  - 第一个数字 `2345`：当前已分配的文件描述符数量。
  - 第二个数字 `0`：未使用的文件描述符数量（通常显示为 0）。
  - 第三个数字 `123456`：系统可以打开的最大文件描述符数量（与 `file-max` 的值一致）。

#### 4. **修改文件描述符限制**

##### 临时修改（当前会话生效）

- 修改当前用户的文件描述符限制，可以通过 `ulimit` 进行临时设置：

  ```bash
  ulimit -n 65535
  ```

  这会将当前用户的文件描述符限制提升至 65535。这个设置在用户登出或系统重启后会恢复默认值。

##### 永久修改（系统重启后生效）

- 修改 `/etc/security/limits.conf` 文件，增加以下配置来永久提升文件描述符的限制：

  ```bash
  * soft nofile 65535
  * hard nofile 65535
  ```

  - `*` 表示对所有用户生效，可以指定具体用户名。
  - `soft nofile` 表示软限制，即用户进程能打开的文件描述符数。
  - `hard nofile` 表示硬限制，即系统层面能打开的最大文件描述符数。

- 修改 `/etc/sysctl.conf` 文件中的全局文件描述符限制：

  添加或修改以下配置项：

  ```bash
  fs.file-max = 65535
  ```

  然后使用以下命令让配置立即生效：

  ```bash
  sysctl -p
  ```

##### 针对某些服务修改（如 NGINX、MySQL）

对于特定的服务进程，也可以在它们的启动脚本或服务配置文件中设置文件描述符限制。例如，在 `systemd` 管理的服务中，你可以编辑 `/etc/systemd/system/<service>.service`，为 NGINX 或其他服务指定文件描述符限制：

- 添加或修改以下行：

  ```ini
  [Service]
  LimitNOFILE=65535
  ```

  然后重启服务和 `systemd` 守护进程以使配置生效：

  ```bash
  systemctl daemon-reload
  systemctl restart nginx
  ```

#### 5. **监控系统资源的工具**

可以使用一些工具来实时监控系统的文件描述符使用情况和其他资源指标：

- **`lsof`**: 用于查看系统中打开的文件描述符。
  
  ```bash
  lsof | wc -l  # 查看当前系统中所有打开的文件描述符数量
  ```

- **`iotop`**: 实时查看进程的 I/O 使用情况。
- **`htop`**: 实时查看系统的资源使用情况，包括 CPU、内存和打开的文件描述符等。

---

通过这些方法，你可以查看、修改和监控系统的文件描述符使用情况，确保服务器能合理管理并发连接和文件操作，避免由于文件描述符不足导致的系统瓶颈问题。


### 本地端口耗尽

检查并调整 Linux 系统的本地端口范围，可以帮助确保系统能够为新的网络连接分配足够的可用端口。默认情况下，系统可能会有较小的本地端口范围，当客户端发起大量连接时，可能会耗尽可用端口，导致无法建立新的连接。

### **步骤 1：检查当前的端口范围**

要检查当前系统分配的本地端口范围，可以使用以下命令：

```bash
sysctl net.ipv4.ip_local_port_range
```

或者直接查看内核配置文件：

```bash
cat /proc/sys/net/ipv4/ip_local_port_range
```

**输出示例**：
```
net.ipv4.ip_local_port_range = 32768 60999
```

这个输出表示本地端口的可用范围是从 `32768` 到 `60999`。可用的端口范围决定了可以分配给客户端的临时端口数量。

### **步骤 2：计算当前可用端口数**

你可以计算当前的端口范围内的可用端口数：

```bash
echo $((60999 - 32768 + 1))
```

**结果**：28332

这表示当前系统有 28332 个可用的端口。如果你有大量短时间内创建和关闭的连接，这个端口数量可能不够。

### **步骤 3：查看本地端口使用情况**

```bash
liutao@liu:~/workspace/web$ ss -s
Total: 28410
TCP:   28244 (estab 28234, closed 3, orphaned 0, timewait 0)

Transport Total     IP        IPv6
RAW       1         0         1        
UDP       2         2         0        
TCP       28241     28238     3        
INET      28244     28240     4        
FRAG      0         0         0    
```

### **步骤 4：修改本地端口范围**

这样就将本地端口范围扩展为从 1024 到 65535，增加了系统可用的端口数量。如果需要更大范围的可用端口（例如增加到 `1024` 到 `65535`），你可以临时修改端口范围：

```bash
sudo sysctl -w net.ipv4.ip_local_port_range="1024 65535"
```

### **步骤 5：永久修改端口范围**

如果你希望这个更改在系统重启后仍然有效，需要将其写入 `/etc/sysctl.conf` 文件：

1. 打开 `/etc/sysctl.conf` 文件：
   ```bash
   sudo nano /etc/sysctl.conf
   ```

2. 添加或修改以下行：
   ```
   net.ipv4.ip_local_port_range = 1024 65535
   ```

3. 保存并退出文件，然后应用更改：
   ```bash
   sudo sysctl -p
   ```

### **步骤 6：验证修改**

再次运行以下命令，确认端口范围已经成功修改：

```bash
sysctl net.ipv4.ip_local_port_range
```

确保输出反映了你所设定的端口范围。

### **总结**

通过调整本地端口范围，系统可以为新的网络连接分配更多的可用端口，这将减少端口耗尽导致的连接问题。在高并发的环境下，合理调整端口范围非常重要。


### 监控SYN_RECV状态的连接数（可能表示SYN Flood攻击或网络阻塞）
> watch "netstat -ant | grep SYN_RECV | wc -l"